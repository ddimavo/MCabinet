<xf:title>
    <xf:if is="$isOwnHistory">
        –ò—Å—Ç–æ—Ä–∏—è –º–æ–∏—Ö —Å–∫–∏–Ω–æ–≤
    <xf:else />
        –ò—Å—Ç–æ—Ä–∏—è —Å–∫–∏–Ω–æ–≤: {$targetUser.username}
    </xf:if>
</xf:title>

<xf:css>
.history-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}
.history-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid var(--mc-border);
}
.history-user-info {
    display: flex;
    align-items: center;
    gap: 15px;
}
.history-user-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
}
.history-user-name {
    font-size: 24px;
    font-weight: 600;
    color: var(--mc-text-primary);
}
.history-stats {
    display: flex;
    gap: 20px;
    color: var(--mc-text-secondary);
}
.history-stat {
    text-align: center;
}
.history-stat-number {
    font-size: 18px;
    font-weight: 600;
    color: var(--mc-primary);
}
.history-stat-label {
    font-size: 12px;
    opacity: 0.8;
}
.history-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}
.history-item {
    background: var(--mc-bg-card);
    border-radius: 12px;
    overflow: hidden;
    transition: all 0.3s ease;
    border: 1px solid var(--mc-border);
    position: relative;
}
.history-item:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}
.history-item-image {
    width: 100%;
    height: 150px;
    background: linear-gradient(45deg, #f5f5f5 25%, transparent 25%, transparent 75%, #f5f5f5 75%),
                linear-gradient(45deg, #f5f5f5 25%, transparent 25%, transparent 75%, #f5f5f5 75%);
    background-size: 20px 20px;
    background-position: 0 0, 10px 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 10px;
}
.history-item-image img {
    max-width: 100%;
    max-height: 130px;
    image-rendering: pixelated;
}
.history-item-info {
    padding: 12px;
    border-top: 1px solid var(--mc-border);
}
.history-item-name {
    font-weight: 600;
    color: var(--mc-text-primary);
    margin-bottom: 5px;
    font-size: 13px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.history-item-date {
    color: var(--mc-text-secondary);
    font-size: 11px;
    margin-bottom: 10px;
}
.history-item-actions {
    display: flex;
    gap: 8px;
}
.history-action-btn {
    flex: 1;
    padding: 8px 12px;
    border: none;
    border-radius: 8px;
    font-size: 11px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
}
.history-action-btn--primary {
    background: linear-gradient(135deg, var(--mc-primary) 0%, var(--mc-secondary) 100%);
    color: white;
}
.history-action-btn--primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}
.history-action-btn--primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none !important;
}
.empty-history {
    text-align: center;
    padding: 60px 20px;
    color: var(--mc-text-muted);
}
.empty-history-icon {
    font-size: 48px;
    margin-bottom: 15px;
    opacity: 0.5;
}
.current-skin-badge {
    position: absolute;
    top: 8px;
    left: 8px;
    background: var(--mc-primary);
    color: white;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 10px;
    font-weight: 600;
}
</xf:css>

<div class="history-container">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="history-header">
        <div class="history-user-info">
            <xf:avatar user="{$targetUser}" size="s" class="history-user-avatar" />
            <h1 class="history-user-name">
                <xf:if is="$isOwnHistory">
                    –ò—Å—Ç–æ—Ä–∏—è –º–æ–∏—Ö —Å–∫–∏–Ω–æ–≤
                <xf:else />
                    –ò—Å—Ç–æ—Ä–∏—è —Å–∫–∏–Ω–æ–≤: {$targetUser.username}
                </xf:if>
            </h1>
        </div>
        
        <div class="history-stats">
            <div class="history-stat">
                <div class="history-stat-number">{$totalSkins}</div>
                <div class="history-stat-label">–í—Å–µ–≥–æ —Å–∫–∏–Ω–æ–≤</div>
            </div>
            <div class="history-stat">
                <div class="history-stat-number">
                    <xf:if is="$activeSkin">
                        üìÖ
                    <xf:else />
                        0
                    </xf:if>
                </div>
                <div class="history-stat-label">–¢–µ–∫—É—â–∏–π</div>
            </div>
        </div>
    </div>

    <!-- –°–µ—Ç–∫–∞ —Å–∫–∏–Ω–æ–≤ -->
    <xf:if is="$skins is not empty">
        <div class="history-grid">
            <xf:foreach loop="$skins" value="$skin">
                <div class="history-item" data-skin-id="{$skin.skin_id}">
                    <div class="history-item-image">
                        <img src="{{ link('skins/preview', null, {'filename': $skin.skin_texture, 'type': 'full', 'size': 150}) }}" 
                             alt="{$skin.skin_name}"
                             loading="lazy"
                             onerror="this.src='{{ link('skins/preview', null, {'type': 'full', 'size': 150}) }}'">
                    </div>
                    
                    <div class="history-item-info">
                        <div class="history-item-name">{$skin.skin_name}</div>
                        <div class="history-item-date">
                            <xf:date time="$skin.upload_date" />
                        </div>
                        
                        <div class="history-item-actions">
                            <button class="history-action-btn history-action-btn--primary" 
                                    data-xf-click="apply-from-history" 
                                    data-skin-id="{$skin.skin_id}"
                                    data-url="{{ link('ddimavo/MCabinet/history/apply', $skin) }}">
                                ‚ö° –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                            </button>
                        </div>
                    </div>
                </div>
            </xf:foreach>
        </div>
        
        <xf:if is="$totalSkins > $perPage">
            <div class="pagination">
                <xf:pagination page="{$page}" perpage="{$perPage}" total="{$totalSkins}" 
                              link="ddimavo/MCabinet/history" data="{'user_id': $targetUser.user_id}" />
            </div>
        </xf:if>
    <xf:else />
        <div class="empty-history">
            <div class="empty-history-icon">üï∞Ô∏è</div>
            <h3>–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</h3>
            <p>
                <xf:if is="$isOwnHistory">
                    –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ —Å–∫–∏–Ω–æ–≤. –í—Å–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Å–∫–∏–Ω—ã –±—É–¥—É—Ç –ø–æ—è–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å.
                <xf:else />
                    –£ —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–∫–∞ –Ω–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ —Å–∫–∏–Ω–æ–≤.
                </xf:if>
            </p>
        </div>
    </xf:if>
</div>

<xf:js>
$(document).ready(function() {
    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∫–∏–Ω–∞ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
    $('[data-xf-click="apply-from-history"]').on('click', function(e) {
        e.preventDefault();
        
        const button = $(this);
        const skinId = button.data('skin-id');
        const url = button.data('url');
        
        button.prop('disabled', true).text('–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º...');
        
        XF.ajax('post', url, {}, function(data) {
            if (data.status === 'ok') {
                XF.alert(data.message);
                button.text('‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(function() {
                    window.location.reload();
                }, 2000);
            } else {
                button.prop('disabled', false).text('‚ö° –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å');
                XF.alert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–∫–∏–Ω–∞');
            }
        }).fail(function() {
            button.prop('disabled', false).text('‚ö° –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å');
            XF.alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
        });
    });
});
</xf:js>